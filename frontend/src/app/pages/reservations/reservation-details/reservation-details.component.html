<div class="container" *ngIf="reservation">
  <div>
    <h2>Reservation Details</h2>
    <div class="details-grid">
      <div><strong>ID:</strong> {{ reservation.id }}</div>
      <div><strong>Description:</strong> {{ reservation.description }}</div>
      <div><strong>Start Date:</strong> {{ reservation.startDate | date }}</div>
      <div><strong>End Date:</strong> {{ (reservation.endDate | date) ?? 'None' }}</div>
      <div><strong>Status:</strong> <span class="status" [ngClass]="reservation.status">{{ reservation.status }}</span></div>
      <div *ngIf="reservation.status === 'cancelled' && reservation.cancelledAt">
        <strong>Cancelled At:</strong> {{ reservation.cancelledAt | date:'medium' }}
      </div>
    </div>

    <h3>Materials</h3>
    <ul *ngIf="aggregatedMaterials.length > 0" class="material-list">
      <li *ngFor="let materialType of aggregatedMaterials" class="material-item material-type-item">
        <div (click)="toggleDetails(materialType)" class="material-type-header">
          <span>{{ materialType.count }}x {{ materialType.type }}</span>
          <span class="arrow" [ngClass]="{'expanded': materialType.isExpanded}"></span>
        </div>
        <ul class="material-instances-list">
          <li *ngFor="let instance of materialType.instances" class="material-instance-detail">
            <a [routerLink]="['/materials', instance.id]" class="material-link">
              {{ instance.name }} ({{ instance.id }})
            </a>
          </li>
        </ul>
      </li>
    </ul>
    <p *ngIf="aggregatedMaterials.length === 0">No materials in this reservation.</p>

    <h3>History</h3>
    <ul *ngIf="reservation.history && reservation.history.length > 0" class="history-list">
      <li *ngFor="let event of reservation.history.reverse()" class="history-item">
        <strong>{{ event.timestamp | date:'medium' }}:</strong>
        <span *ngIf="event.action === 'add_materials'">Added materials:</span>
        <span *ngIf="event.action === 'remove_material'">Removed material:</span>
        <ul *ngIf="event.materials">
          <li *ngFor="let material of event.materials">{{ material.name }} ({{ material.id }})</li>
        </ul>
        <div *ngIf="event.material">{{ event.material.name }} ({{ event.material.id }})</div>
      </li>
    </ul>
    <p *ngIf="!reservation.history || reservation.history.length === 0">No history for this reservation.</p>
  </div>

  <h3>Actions</h3>
  <button (click)="exportToPDF()">Export to PDF</button>

  <div class="actions" *ngIf="reservation.status === 'active'">
    <button (click)="cancelReservation()">Cancel Reservation</button>
    <button (click)="endReservation()">End Reservation</button>
    <button (click)="showAddMaterials = !showAddMaterials">Add Materials</button>
  </div>

  <div *ngIf="showAddMaterials" class="add-materials-form">
    <h4>Add More Materials</h4>
    <div class="material-request-form">
      <div class="request-type-selector">
        <label><input type="radio" name="materialRequestType" value="type" [(ngModel)]="materialRequestType"> By Type & Location</label>
        <label><input type="radio" name="materialRequestType" value="id" [(ngModel)]="materialRequestType"> By Specific IDs</label>
      </div>

      <div *ngIf="materialRequestType === 'type'">
        <div class="form-group">
          <label for="materialType">Material Type</label>
          <select id="materialType" [(ngModel)]="materialRequest.type" name="materialType">
            <option value="">-- Select a Type --</option>
            <option *ngFor="let type of materialTypes" [value]="type.type">{{ type.type }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quantity">Quantity</label>
          <input type="number" id="quantity" [(ngModel)]="materialRequest.quantity" name="quantity" min="1">
        </div>
        <div class="form-group">
          <label for="fromRoom">From Room</label>
          <select id="fromRoom" [(ngModel)]="materialRequest.fromRoom" name="fromRoom">
            <option value="">-- Select a Room --</option>
            <option *ngFor="let room of rooms" [value]="room.id">{{ room.name }}</option>
          </select>
        </div>
      </div>

      <div *ngIf="materialRequestType === 'id'">
        <div class="form-group">
          <label for="ids">Material IDs (comma-separated)</label>
          <input type="text" id="ids" [(ngModel)]="materialRequest.ids" name="ids">
        </div>
      </div>

      <button type="button" (click)="addMaterials()">Add to Reservation</button>
    </div>
  </div>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

</div>

<div *ngIf="!reservation">
  <p>Loading reservation details...</p>
</div>
